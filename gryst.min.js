"use strict";var gryst=gryst||{};gryst.agg={max:function(a,b){var c=a;return b&&(c=[],a.forEach(function(d,e){c[e]=a[e][b]})),Math.max.apply(this,c)},min:function(a,b){var c=a;return b&&(c=[],a.forEach(function(d,e){c[e]=a[e][b]})),Math.min.apply(this,c)},avg:function(a,b){var c=0,d=0;return a.forEach(function(a){c++,d+=null==a[b]?0:a[b]}),d/c}},function(){var a=function(a,b){b=b||{bubbles:!1,cancelable:!1,detail:void 0};var c=document.createEvent("CustomEvent");return c.initCustomEvent(a,b.bubbles,b.cancelable,b.detail),c};a.prototype=window.Event.prototype,window.CustomEvent=a}(),gryst.common={getParamNames:function(a){var b=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,c=/([^\s,]+)/g,d=a.toString().replace(b,""),e=d.slice(d.indexOf("(")+1,d.indexOf(")")).match(c);return null===e&&(e=[]),e},hasValue:function(a){return void 0!=a&&null!=a},getArguments:function(a,b){var c,d=[],e=this;return a.forEach(function(a){c=a.table[b[a.id]],d.push(e.getArg(a,c))}),d},getArgForMapping:function(a,b){var c=a.table[b[a.id]];return this.getArg(a,c)},getArg:function(a,b){return void 0!=a.field?b[a.field]:void 0!=a.index?b[a.index]:b},addToMap:function(a,b,c){Array.isArray(b)&&b.forEach(function(b){gryst.common.addToMap(a,b,c)}),a.hasOwnProperty(b)?(Array.isArray(a[b])===!1&&(a[b]=[a[b]]),a[b].push(c)):a[b]=c},cloneObj:function(a){var b={};if(void 0==a||null==a)return b;var c=Object.getOwnPropertyNames(a);return c.forEach(function(c){b[c]=a[c]}),b},detectType:function(a){if(null==a)return null;var b=typeof a;if("number"===b||"string"===b||"boolean"===b)return b;if(a instanceof Date)return"date";if(Array.isArray(a))return"array";if("object"===b)return b;throw"Could not determine type"},isEmpty:function(a){return void 0===a||null===a},getFieldRefs:function(a,b){var c=[],d=Array.isArray(a)?a:a.split(",");return d.forEach(function(a){a=a.trim(),"$"!=a[0]&&c.push(gryst.common.getField(a,b))}),c},getField:function(a,b){var c,d;if(-1!=a.indexOf("."))return d=a.split("."),{id:d[0],field:d[1],table:b[d[0]],toString:function(){return this.field}};if(-1!=a.indexOf("["))return d=a.split("["),{id:d[0],index:parseInt(a.match(/\d+/)),table:b[d[0]],toString:function(){return this.id+"_"+this.index}};if(void 0!=b[a])return{id:a,table:b[a],toString:function(){return this.id}};var e=Object.getOwnPropertyNames(b);for(c=0;c<e.length;c++)if(b[e[c]].length>0&&void 0!=b[e[c]][0][a])return{id:e[c],field:a,table:b[e[c]],toString:function(){return this.field}};throw"Could not resolve field reference: "+a},l:"abcdefghijklmnopqrstuvwxyz",createTableID:function(a,b){b=b||"";for(var c,d=0;d<gryst.common.l.length;d++)if(c=b+gryst.common.l[d],!(c in a))return c;return gryst.common.createTableID(a,b+"a")}},function(){gryst.from=function(a,b){return(new gryst.Query).from(a,b)},gryst.From=function(a,b,c,d){this.tableID=a,this.tables=b,this.getJoinMap=c,this.setJoinMap=d},gryst.From.$inject=["$tables","$getJoinMap","$setJoinMap"],gryst.From.prototype={run:function(){var b,c,a=this,d=this.getJoinMap(),e=this.tables[this.tableID];return 0!=d.length?(c=[],d.forEach(function(d){e.forEach(function(e,f){b=gryst.common.cloneObj(d),b[a.tableID]=f,c.push(b)})}),this.setJoinMap(c),c):(e.forEach(function(c,e){b={},b[a.tableID]=e,d.push(b)}),d)}}}(),function(){gryst.Group=function(a,b,c,d,e,f){this.tables=d,this.getJoinMap=e,this.setJoinMap=f,this.tableID=c,"function"==typeof a?(this.groupFunc=a,this.groupFuncParams=gryst.common.getParamNames(a)):this.groupFuncParams=a,"function"==typeof b?(this.keyFunc=b,this.keyFuncParams=gryst.common.getParamNames(b)):this.keyFuncParams=b},gryst.Group.$inject=["$tables","$getJoinMap","$setJoinMap"],gryst.Group.prototype={run:function(){var b,c,d,e,f,a=this,g=this.getJoinMap(),h=gryst.common.getFieldRefs(this.keyFuncParams,this.tables),i=gryst.common.getFieldRefs(this.groupFuncParams,this.tables),j=new gryst.Grouping;return this.tables[this.tableID]=[],0==g.length?this.tables[this.tableID]:(this.keyFunc?g.forEach(function(b){c=gryst.common.getArguments(h,b),e=a.keyFunc.apply(a,c),j.addKey(e,b)}):g.forEach(function(a){e={},h.forEach(function(c){b=gryst.common.getArgForMapping(c,a),e[c.toString()]=b}),j.addKey(e,a)}),this.tables[this.tableID]=j.getResult(i,this.groupFunc),f=[],this.tables[this.tableID].forEach(function(b,c){d={},d[a.tableID]=c,f.push(d)}),this.setJoinMap(f),this.tables[this.tableID])}}}(),function(){gryst.Grouping=function(){this.keys=[],this.coerced=[],this.map={},this.type=null};var a={coerceKey:function(b,c){switch(c){case null:case"number":case"string":case"boolean":return b.toString();case"date":return b.getTime().toString();case"object":case"array":return a.stringify(b);case"function":throw"Grouping by functions is not supported";default:throw"Could not determine key type"}},getArgs:function(a,b){var c,d=[];return b.forEach(function(b){c=gryst.common.getArguments(a,b),c=1==c.length?c[0]:c,d.push(c)}),d}};a.stringify=JSON.stringify||function(b){var c,d,e,f=[];switch(c=gryst.common.detectType(b)){case null:f.push("null");break;case"number":case"boolean":f.push(b);break;case"string":f.push('"'+b+'"');break;case"date":f.push("Date("+b.getTime()+")");break;case"array":for(f.push("["),d=0;d<b.length;d++)d>0&&f.push(","),f.push(a.stringify(b[d]));f.push("]");break;case"object":for(e=Object.getOwnPropertyNames(b),f.push("{"),d=0;d<e.length;d++)d>0&&f.push(","),f.push('"'+e[d]+'":'),f.push(a.stringify(b[e[d]]));f.push("}");break;default:throw"Could not determine type: "+b}return f.join("")},gryst.Grouping.prototype={addKey:function(b,c){null==this.type&&(this.type=gryst.common.detectType(b));var d=a.coerceKey(b,this.type);return this.map.hasOwnProperty(d)||(this.map[d]=[],this.keys.push(b),this.coerced.push(d)),this.map[d].push(c),d},getResult:function(b,c){var d,e,f,g,h,i,j=[];if(c)for(h=0;h<this.keys.length;h++)i=this.coerced[h],d=this.map[i],e=a.getArgs(b,d),g=1==b.length?c.call(gryst.agg,e):c.apply(gryst.agg,e),j.push({key:this.keys[h],values:g});else for(h=0;h<this.keys.length;h++)i=this.coerced[h],d=this.map[i],e=a.getArgs(b,d),g=[],e.forEach(function(a){f={},b.forEach(function(b,c){void 0!=b.field?f[b.field]=a[c]:f=gryst.common.cloneObj(a)}),g.push(f)}),j.push({key:this.keys[h],values:g});return j}}}(),function(){gryst.Injector=function(a){this.dep={$tables:a.tables,$getMap:function(b,c){return a.getMap(b,c)},$getJoinMap:function(){return a.joinMap},$setJoinMap:function(b){a.joinMap=b},$agg:gryst.agg,$injector:this}},gryst.Injector.prototype={inject:function(a,b){b=b||[];var c,d=this;return a.$inject?a.$inject.forEach(function(a){if(!d.dep.hasOwnProperty(a))throw"Unrecognized dependency: "+a;b.push(d.dep[a])}):(c=gryst.common.getParamNames(a),c.forEach(function(a){d.dep.hasOwnProperty(a)&&b.push(d.dep[a])})),b}}}(),function(){gryst.Join=function(a,b,c,d,e,f){if(this.getMap=c,this.tables=d,this.getJoinMap=e,this.setJoinMap=f,gryst.common.isEmpty(a)||gryst.common.isEmpty(b))throw"Join is missing field references.";this.field1=a,this.field2=b},gryst.Join.$inject=["$getMap","$tables","$getJoinMap","$setJoinMap"];var a={setFieldReferences:function(a){if(a.length>0)if(a[0].hasOwnProperty(this.fieldRef1.id))this.leftField=this.fieldRef1,this.rightField=this.fieldRef2;else{if(!a[0].hasOwnProperty(this.fieldRef2.id))throw"Join failed: unable to resolve field references: "+this.field1+","+this.field2;this.leftField=this.fieldRef2,this.rightField=this.fieldRef1}}};gryst.Join.prototype={run:function(){var b=this.getJoinMap();if(0==b.length)return b;if(this.fieldRef1=gryst.common.getField(this.field1,this.tables),this.fieldRef2=gryst.common.getField(this.field2,this.tables),0!=b.length){a.setFieldReferences.call(this,b);var e,f,g,c=this,h=[],i=this.getMap(this.rightField);return b.forEach(function(a){f=gryst.common.getArgForMapping(c.leftField,a),i.hasOwnProperty(f)&&(g=i[f],Array.isArray(g)||(g=[g]),g.forEach(function(b){e=gryst.common.cloneObj(a),e[c.rightField.id]=b,h.push(e)}))}),this.setJoinMap(h),h}}}}(),function(){gryst.JoinMap=function(a,b){var c=this;this.tables=b,this.map=a,this.run=function(){var a,b,d=[],e=this.map.length>0?Object.getOwnPropertyNames(this.map[0]):null;return e&&(1==e.length?(a=e[0],this.map.forEach(function(e){b=c.tables[a][e[a]],d.push(b)})):this.map.forEach(function(a){b={},e.forEach(function(d){b[d]=c.tables[d][a[d]]}),d.push(b)})),d}},gryst.JoinMap.$inject=["$tables"]}(),function(){gryst.extend=function(b,c,d){d&&(c.$inject=d),gryst.Query.prototype[b]=function(b){var d=a.createOp.call(this,c,b);return this.runnable.ops.push(d),this}},gryst.Query=function(){var a=this;this.runnable=new gryst.Runnable,this.injector=new gryst.Injector(this.runnable),Object.defineProperty(this,"length",{get:function(){return null==a.runnable.result&&a.runnable.run(),a.runnable.result.length}})};var a={createOp:function(a,b){return b=Array.isArray(b)?b:[b],this.injector.inject(a,b),new a(b[0],b[1],b[2],b[3],b[4],b[5],b[6],b[7],b[8],b[9])}};gryst.Query.prototype={from:function(b,c){c=c||gryst.common.createTableID(this.runnable.tables),this.runnable.tables[c]=b;var d=a.createOp.call(this,gryst.From,c);return this.runnable.ops.push(d),this},join:function(b,c,d,e){this.runnable.tables[c]=b;var f=a.createOp.call(this,gryst.Join,[d,e]);return this.runnable.ops.push(f),this},where:function(b){var c=a.createOp.call(this,gryst.Where,b);return this.runnable.ops.push(c),this},orderBy:function(b,c){var d=a.createOp.call(this,gryst.Sort,[b,!1,c]);return this.runnable.ops.push(d),this},thenBy:function(b,c){var d=a.createOp.call(this,gryst.Sort,[b,!1,c]);return this.runnable.addChildSort(d),this},orderByDescending:function(b,c){var d=a.createOp.call(this,gryst.Sort,[b,!0,c]);return this.runnable.ops.push(d),this},thenByDescending:function(b,c){var d=a.createOp.call(this,gryst.Sort,[b,!0,c]);return this.runnable.addChildSort(d),this},group:function(b,c,d){var e=a.createOp.call(this,gryst.Group,[b,c,d]);return this.runnable.ops.push(e),this},select:function(b,c){var d=a.createOp.call(this,gryst.Select,[b,c]);return this.runnable.ops.push(d),this},forEach:function(a){var b=this,c=this.runnable.run();c.forEach(function(c,d){a.call(b,c,d)})},run:function(){return this.runnable.run()},get:function(a){return null==this.runnable.result&&this.runnable.run(),this.runnable.result[a]}}}(),function(){gryst.Runnable=function(){this.tables={},this.joinMap=[],this.ops=[],this.result=null},gryst.Runnable.prototype={addChildSort:function(a){for(var b=this.ops.length-1;b>=0;b--)if(this.ops[b]instanceof gryst.Sort)return this.ops[b].setChild(a),void 0;this.ops.push(a)},getMap:function(a){var c,b=this.tables[a.id];return b.hasOwnProperty("Maps")||(b.Maps={}),b.Maps.hasOwnProperty(a.toString())?b.Maps[a.toString()]:(c={},b.forEach(function(b,d){gryst.common.addToMap(c,gryst.common.getArg(a,b),d)}),b.Maps[a.toString()]=c,c)},run:function(){var a=this;return this.joinMap=[],this.result=null,this.ops.forEach(function(b){a.result=b.run()}),this.result===this.joinMap?new gryst.JoinMap(this.joinMap,this.tables).run():this.result}}}(),function(){gryst.Select=function(a,b,c,d){if(this.tables=c,this.getJoinMap=d,this.tableID=b,"function"==typeof a){if(this.func=a,this.params=gryst.common.getParamNames(a),0===this.params.length)throw"Select function has no parameters."}else this.params=a},gryst.Select.$inject=["$tables","$getJoinMap"],gryst.Select.prototype={run:function(){var b,c,d,a=this,e=this.getJoinMap();if(this.tableID=this.tableID||gryst.common.createTableID(this.tables),this.tables[this.tableID]=[],0==e.length)return this.tables[this.tableID];var f=gryst.common.getFieldRefs(this.params,this.tables);return this.func?e.forEach(function(d){c=gryst.common.getArguments(f,d),b=a.func.apply(a,c),a.tables[a.tableID].push(b)}):e.forEach(function(b){d={},1==f.length?d=gryst.common.getArgForMapping(f[0],b):f.forEach(function(a){d[a.toString()]=gryst.common.getArgForMapping(a,b)}),a.tables[a.tableID].push(d)}),this.tables[this.tableID]}}}(),gryst.extend("skip",function(a,b,c){this.run=function(){var d=b().slice(a);return c(d),d}},["$getJoinMap","$setJoinMap"]),gryst.extend("take",function(a,b,c){this.run=function(){var d=b().slice(0,a);return c(d),d}},["$getJoinMap","$setJoinMap"]),function(){gryst.Sort=function(a,b,c,d,e,f){this.tables=d,this.getJoinMap=e,this.setJoinMap=f,this.field=a,this.desc=b,this.childSort=null,this.type=null,this.func=c,this.fieldRef=null,this.sortFunction=null},gryst.Sort.$inject=["$tables","$getJoinMap","$setJoinMap"];var a={getSortType:function(a){var b,c,d;if(a.table.length>0){for(d=null,b=0;b<a.table.length&&gryst.common.isEmpty(d);b++)d=gryst.common.getArg(a,a.table[b]);if(!gryst.common.isEmpty(d))switch(c=gryst.common.detectType(d)){case"number":case"date":return c;default:return"string"}}},getSortFunction:function(){var b,c=this;return this.fieldRef=gryst.common.getField(this.field,this.tables),void 0!=this.func?function(a,b){var d=gryst.common.getArgForMapping(c.fieldRef,a),e=gryst.common.getArgForMapping(c.fieldRef,b),f=c.func(d,e);return 0==f&&null!=c.childSort?c.childSort.sort(a,b):f}:(b=a.getSortType(this.fieldRef),"number"===b||"date"===b?this.desc===!0?function(a,b){var f,d=gryst.common.getArgForMapping(c.fieldRef,a),e=gryst.common.getArgForMapping(c.fieldRef,b);if(null===d){if(null!=e)return 1}else if(null===e)return-1;return f=e-d,0==f&&null!=c.childSort?c.childSort.sort(a,b):f}:function(a,b){var f,d=gryst.common.getArgForMapping(c.fieldRef,a),e=gryst.common.getArgForMapping(c.fieldRef,b);if(null===d){if(null!=e)return-1}else if(null===e)return 1;return f=d-e,0==f&&null!=c.childSort?c.childSort.sort(a,b):f}:this.desc===!0?function(a,b){var d=gryst.common.getArgForMapping(c.fieldRef,a),e=gryst.common.getArgForMapping(c.fieldRef,b);if(null===d){if(null!=e)return 1}else{if(null===e)return-1;if(d>e)return-1;if(e>d)return 1}return null!=c.childSort?c.childSort.sort(a,b):0}:function(a,b){var d=gryst.common.getArgForMapping(c.fieldRef,a),e=gryst.common.getArgForMapping(c.fieldRef,b);if(null===d){if(null!=e)return-1}else{if(null===e)return 1;if(d>e)return 1;if(e>d)return-1}return null!=c.childSort?c.childSort.sort(a,b):0})}};gryst.Sort.prototype={setChild:function(a){null==this.childSort?(a.isRoot=!1,this.childSort=a):this.childSort.setChild(a)},sort:function(b,c){var d;return null===this.sortFunction&&(this.sortFunction=a.getSortFunction.call(this)),d=this.sortFunction(b,c),0==d&&null!=this.childSort?this.childSort.sort(b,c):d},run:function(b){return b||(b=this.getJoinMap()),b.length<2?b:(this.sortFunction=a.getSortFunction.call(this),b.sort(this.sortFunction),b)}}}(),function(){gryst.Where=function(a,b,c,d){if(this.tables=b,this.getJoinMap=c,this.setJoinMap=d,this.func=a,this.params=gryst.common.getParamNames(a),0===this.params.length)throw"Where function has no parameters."},gryst.Where.$inject=["$tables","$getJoinMap","$setJoinMap"],gryst.Where.prototype={run:function(){var a,b,e,c=this,d=!1,f=this.getJoinMap();if(0==f.length)return f;var g=gryst.common.getFieldRefs(this.params,this.tables);return f.forEach(function(e,h){a=gryst.common.getArguments(g,e),b=c.func.apply(c,a),b===!1&&(delete f[h],d=!0)}),d?(e=[],Object.keys(f).forEach(function(a){e.push(f[a])}),this.setJoinMap(e),e):f}}}();